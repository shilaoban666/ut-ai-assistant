name: IDEA Plugin CI

on:
  push:
    branches:
      - develop
      - release
      - master
  pull_request:
    branches:
      - develop
      - release

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # =========================
      # 1Ô∏è‚É£ ÊãâÂèñ‰ª£Á†Å
      # =========================
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================
      # 2Ô∏è‚É£ ÂÆâË£Ö JDK 17
      # =========================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle


      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      # =========================
      # 3Ô∏è‚É£ Gradle Âü∫Á°ÄÊûÑÂª∫ÔºàÊâÄÊúâÂàÜÊîØÔºâ
      # =========================
      - name: Gradle build
        run: ./gradlew build --no-daemon

      # =========================
      # 4Ô∏è‚É£ ÂçïÂÖÉÊµãËØïÔºàdevelop / releaseÔºâ
      # =========================
      - name: Run unit tests
        if: github.ref != 'refs/heads/master'
        run: ./gradlew test --no-daemon

      # =========================
      # 5Ô∏è‚É£ JaCoCo Ë¶ÜÁõñÁéáÔºà‰ªÖ releaseÔºâ
      # =========================
      - name: Generate coverage report
        if: github.ref == 'refs/heads/release'
        run: ./gradlew jacocoTestReport --no-daemon

      # =========================
      # 6Ô∏è‚É£ ÊûÑÂª∫ IDEA Êèí‰ª∂ÂåÖÔºàÈùû masterÔºâ
      # =========================
      - name: Build IDEA plugin
        if: github.ref != 'refs/heads/master'
        run: ./gradlew buildPlugin --no-daemon

      # =========================
      # 7Ô∏è‚É£ ÁîüÊàê PR DiffÔºà‰ªÖ PRÔºâ
      # =========================
      - name: Generate PR diff
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff
          echo "DIFF_SIZE=$(wc -c < pr.diff)" >> $GITHUB_ENV

      # =========================
      # 8Ô∏è‚É£ AI Code ReviewÔºà‰ªÖ PRÔºâ
      # =========================
      - name: AI Code Review (IDEA Plugin)
        if: github.event_name == 'pull_request' && env.DIFF_SIZE != '0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests

          with open("pr.diff", encoding="utf-8", errors="ignore") as f:
              diff = f.read()

          prompt = f"""
          ‰Ω†ÊòØ IntelliJ IDEA Êèí‰ª∂‰∏é Java Êû∂ÊûÑ‰∏ìÂÆ∂ÔºåËØ∑ÂÆ°Êü•‰ª•‰∏ã‰ª£Á†ÅÂèòÊõ¥„ÄÇ

          ÈáçÁÇπÂÖ≥Ê≥®Ôºö
          1. ÊòØÂê¶ÈòªÂ°û EDTÔºàUI Á∫øÁ®ãÔºâ
          2. ÊòØÂê¶Â≠òÂú®‰∏çÂΩìÁöÑÂêéÂè∞Á∫øÁ®ã / ËµÑÊ∫êÊ≥ÑÊºè
          3. ÊòØÂê¶ÂΩ±ÂìçÊèí‰ª∂ÁîüÂëΩÂë®ÊúüÔºàproject / editor / startupÔºâ
          4. AI ÊàñÁΩëÁªú IO ÊòØÂê¶ÂèØËÉΩÂØºËá¥ IDE Âç°È°ø
          5. ÊòØÂê¶Á¨¶Âêà IDEA Êèí‰ª∂ÊúÄ‰Ω≥ÂÆûË∑µ

          ‰∏çË¶ÅËØÑËÆ∫Ê†ºÂºèÊàñÂëΩÂêçÈóÆÈ¢ò„ÄÇ

          Diff:
          {diff[:12000]}
          """

          payload = {
              "model": "gpt-4o-mini",
              "messages": [
                  {"role": "system", "content": "‰Ω†ÊòØ‰∏•Ë∞®ÁöÑ IntelliJ IDEA Êèí‰ª∂‰ª£Á†ÅÂÆ°Êü•‰∏ìÂÆ∂"},
                  {"role": "user", "content": prompt}
              ],
              "temperature": 0.2
          }

          response = requests.post(
              "https://api.openai.com/v1/chat/completions",
              headers={
                  "Authorization": f"Bearer {os.environ['OPENAI_API_KEY']}",
                  "Content-Type": "application/json"
              },
              data=json.dumps(payload),
              timeout=60
          )

          review = response.json()["choices"][0]["message"]["content"]

          requests.post(
              f"https://api.github.com/repos/{os.environ['REPO']}/issues/{os.environ['PR_NUMBER']}/comments",
              headers={
                  "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
                  "Accept": "application/vnd.github+json"
              },
              data=json.dumps({"body": f"### ü§ñ AI Plugin Review\n\n{review}"})
          )
          EOF
