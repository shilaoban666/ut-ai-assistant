name: IDEA Plugin CI with AI Review

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ JDKÔºàIDEA Êèí‰ª∂Âº∫ÁÉàÂª∫ËÆÆ 17Ôºâ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 3Ô∏è‚É£ ÊûÑÂª∫Êèí‰ª∂
      - name: Build plugin
        run: ./gradlew buildPlugin --no-daemon

      # 4Ô∏è‚É£ ÂçïÂÖÉÊµãËØï
      - name: Run tests
        run: ./gradlew test --no-daemon

      # 5Ô∏è‚É£ ÈùôÊÄÅÂàÜÊûêÔºàÂ¶ÇÊûú‰Ω†ÊúâÈÖçÁΩÆÔºâ
      - name: Static analysis
        run: ./gradlew check --no-daemon

      # 6Ô∏è‚É£ IntelliJ Plugin VerifierÔºàÈùûÂ∏∏ÂÖ≥ÈîÆÔºâ
      - name: Verify plugin compatibility
        run: |
          ./gradlew runPluginVerifier \
            -Pplugin.verifier.ideVersions=2023.1,2023.2,2024.1

      # 7Ô∏è‚É£ ÁîüÊàê PR DiffÔºàÁªô AIÔºâ
      - name: Generate PR diff
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff
          echo "DIFF_SIZE=$(wc -c < pr.diff)" >> $GITHUB_ENV

      # 8Ô∏è‚É£ AI Code ReviewÔºàËÅöÁÑ¶Êèí‰ª∂Ê†∏ÂøÉÔºâ
      - name: AI Review for IDEA Plugin
        if: github.event_name == 'pull_request' && env.DIFF_SIZE != '0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'EOF'
          import os, requests, json

          diff = open("pr.diff", encoding="utf-8", errors="ignore").read()

          prompt = f"""
‰Ω†ÊòØ‰∏Ä‰∏™ IntelliJ IDEA Êèí‰ª∂‰∏é Java Êû∂ÊûÑ‰∏ìÂÆ∂ÔºåËØ∑ÂÆ°Êü•‰ª•‰∏ãÊèí‰ª∂‰ª£Á†ÅÂèòÊõ¥Ôºö

ÂÖ≥Ê≥®ÈáçÁÇπÔºö
1. ÊòØÂê¶Á†¥Âùè IDEA Êèí‰ª∂ÁîüÂëΩÂë®ÊúüÔºàstartup / project / editorÔºâ
2. ÊòØÂê¶Â≠òÂú®ÈòªÂ°û EDT ÁöÑÈ£éÈô©
3. ÊòØÂê¶Â≠òÂú®Á∫øÁ®ãÊàñËµÑÊ∫êÊ≥ÑÊºèÈóÆÈ¢ò
4. AI / ÁΩëÁªúË∞ÉÁî®ÊòØÂê¶ÂèØËÉΩÂΩ±Âìç IDE ÂìçÂ∫îÊÄß
5. ‰ª£Á†ÅÁªìÊûÑÊòØÂê¶Á¨¶ÂêàÊèí‰ª∂ÊúÄ‰Ω≥ÂÆûË∑µ

‰∏çË¶ÅËØÑËÆ∫‰ª£Á†ÅÊ†ºÂºèÊàñÁÆÄÂçïÂëΩÂêçÈóÆÈ¢òÔºåÂè™ÂÖ≥Ê≥®Êû∂ÊûÑ‰∏éÁ®≥ÂÆöÊÄß„ÄÇ

Diff:
{diff[:12000]}
"""

          payload = {
              "model": "gpt-4o-mini",
              "messages": [
                  {"role": "system", "content": "‰Ω†ÊòØ‰∏Ä‰∏™‰∏•Ë∞®ÁöÑ IntelliJ IDEA Êèí‰ª∂‰ª£Á†ÅÂÆ°Êü•‰∏ìÂÆ∂„ÄÇ"},
                  {"role": "user", "content": prompt}
              ],
              "temperature": 0.2
          }

          r = requests.post(
              "https://api.openai.com/v1/chat/completions",
              headers={
                  "Authorization": f"Bearer {os.environ['OPENAI_API_KEY']}",
                  "Content-Type": "application/json"
              },
              data=json.dumps(payload),
              timeout=60
          )

          review = r.json()["choices"][0]["message"]["content"]

          requests.post(
              f"https://api.github.com/repos/{os.environ['REPO']}/issues/{os.environ['PR_NUMBER']}/comments",
              headers={
                  "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
                  "Accept": "application/vnd.github+json"
              },
              data=json.dumps({"body": f"### ü§ñ AI Plugin Review\n\n{review}"})
          )
          EOF
